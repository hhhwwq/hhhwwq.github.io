---
title: 跨域问题
date: 2019-12-03 15:36:05
tags: "JavaScript"
---


# 跨域问题



## 什么是跨域

> 跨域，是指浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是浏览器对`JavaScript`实施的安全限制。所谓的同源是指，域名、协议、端口均为相同。

同源策略限制了以下的行为：

- `Cookie、LocalStorage` 和 `IndexDB` 无法读取
- `DOM` 和 `JS` 对象无法获取
- `Ajax`请求发送不出去

## 跨域的常见解决办法

---

### jsonp跨域

`jsonp`跨域其实也是`JavaScript`设计模式中的一种代理模式。在`html`页面中通过相应的标签从不同域名下加载静态资源文件是被浏览器允许的，所以我们可以通过这个“犯罪漏洞”来进行跨域。一般，我们可以动态的创建`script`标签，再去请求一个带参网址来实现跨域通信。

    //原生的实现方式
    let script = document.createElement('script');
    
    script.src = 'http://www.abc.cn/login?username=abc&callback=callback';
    
    document.body.appendChild(script);
    
    function callback(res) {
      console.log(res);
    }
    

当然，jquery也支持jsonp的实现方式

    $.ajax({
        url:'http://www.abc.cn/login',
        type:'GET',
        dataType:'jsonp',//请求方式为jsonp
        jsonpCallback:'callback',
        data:{
            "username":"abc"
        }
    })
    

虽然这种方式非常好用，但是一个最大的缺陷是，只能够实现get请求。

### 跨域资源共享 CORS

CORS是一个W3C标准，全称是&rdquo;跨域资源共享&rdquo;（`Cross-origin resource sharing`）。 它允许浏览器向跨源服务器，发出`XMLHttpRequest`请求，从而克服了`AJAX`只能同源使用的限制。CORS需要浏览器和服务器同时支持。

整个CORS通信过程，都是浏览器自动完成，不需要用户参与。对于开发者来说，CORS通信与同源的AJAX通信没有差别，代码完全一样。浏览器一旦发现`AJAX`请求跨源，就会自动添加一些附加的头信息，有时还会多出一次附加的请求，但用户不会有感觉。
因此，实现CORS通信的关键是服务器。只要服务器实现了CORS接口，就可以跨源通信。

#### 两种请求

一种是简单请求，另一种是非简单请求。之所以分为两种请求，是因为浏览器对这两种请求的处理方式不同，只要满足下面条件就是简单请求：

- 
请求方式为HEAD、POST 或者 GET

- 
http头信息不超出一下字段：Accept、Accept-Language 、 Content-Language、 Last-Event-ID、 Content-Type(限于三个值：application/x-www-form-urlencoded、multipart/form-data、text/plain)

简单请求：对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段。 下面是一个例子，浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个Origin字段。

非简单请求：非简单请求是那种对服务器有特殊要求的请求，比如请求方法是PUT或DELETE，或者Content-Type字段的类型是application/json。

非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为&rdquo;预检&rdquo;请求（preflight）。

浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。

### 结束语

CORS与JSONP的使用目的相同，但是比JSONP更强大。JSONP只支持GET请求，CORS支持所有类型的HTTP请求。JSONP的优势在于支持老式浏览器，以及可以向不支持CORS的网站请求数据。

      